# [在线商城](https://gitee.com/warmfrog/sdata-samples.git)

## 产品目录

### 技术整合

* Mybatis(mybatis-spring-boot-starter)
* 逆向工程生成代码(mybais-generator)
* HikariCP集成和配置(Spring Boot 2 默认HikariCP作为连接池)
* 后台Mytatis物理分页(Page Helper)
* 前端分页插件 (Bootstrap Table)

### mybatis-generator

```xml
<plugin>
    <groupId>org.mybatis.generator</groupId>
    <artifactId>mybatis-generator-maven-plugin</artifactId>
    <version>1.3.6</version>
    <configuration>
        <configurationFile>src/main/resources/mybatis/generator-config.xml</configurationFile>
        <overwrite>true</overwrite>
    </configuration>
    <dependencies>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>${mysql.version}</version>
        </dependency>
    </dependencies>
</plugin>
```

generator-config.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE generatorConfiguration
        PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
        "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd">

<generatorConfiguration>
    <context id="MySQLTables" targetRuntime="MyBatis3">
        <!--Official Plugins-->
        <!--Generate equals and hash code-->
        <plugin type="org.mybatis.generator.plugins.EqualsHashCodePlugin"/>

        <jdbcConnection driverClass="com.mysql.cj.jdbc.Driver"
                        connectionURL="jdbc:mysql://localhost:3306/ecommerce_sample?useUnicode=yes&amp;characterEncoding=UTF-8&amp;useSSL=false"
                        userId="root"
                        password="admin">
            <property name="useInformationSchema" value="true"/>
        </jdbcConnection>

        <javaTypeResolver>
            <property name="forceBigDecimals" value="false"/>
        </javaTypeResolver>

        <javaModelGenerator targetPackage="com.sdata.ecommerce.domain" targetProject="src/main/java">
            <property name="enableSubPackages" value="true"/>
            <property name="trimStrings" value="true"/>
        </javaModelGenerator>

        <sqlMapGenerator targetPackage="mapper" targetProject="src/main/resources/mybatis">
            <property name="enableSubPackages" value="true"/>
        </sqlMapGenerator>

        <javaClientGenerator type="XMLMAPPER" targetPackage="com.sdata.ecommerce.mapper" targetProject="src/main/java">
            <property name="enableSubPackages" value="true"/>
        </javaClientGenerator>

        <table schema="ecommerce_sample" tableName="sdata_category" domainObjectName="Category">
            <property name="constructorBased" value="true"/>
            <generatedKey column="id" sqlStatement="select uuid_short()" identity="false"/>
        </table>
    </context>
</generatorConfiguration>
```

### mybatis-spring-boot-starter

做了什么？

1. 检测 DataSource
2. 将 DataSource 注入到 SqlSessionFactory
3. 通过 SqlSessionFactory 获取 SqlSessionTemplate
4. 扫描Mappers，将Mapper通过反射生成bean，将 SqlSessionTemplate 注入mapper， Mapper就可以通过SqlSessionTemplate拿到 ThreadLocal 的 Session 去执行 SQL 操作

### HikariCP数据库连接池

![sql connection without pool](/img/sql_no_pool.jpg)

![sql connectionwith pool](/img/sql_with_pool.jpg)

![sql common database pool](img/common_database_pool.png)

### [Mybatis-page-helper](https://github.com/pagehelper/Mybatis-PageHelper)

除了 PageHelper.startPage 方法外，还提供了类似用法的 PageHelper.offsetPage 方法。

在你需要进行分页的 MyBatis 查询方法前调用 PageHelper.startPage 静态方法即可，紧跟在这个方法后的第一个MyBatis 查询方法会被进行分页。

```java
//获取第1页，10条内容，默认查询总数count
PageHelper.startPage(1, 10);
//紧跟着的第一个select方法会被分页
List<Country> list = countryMapper.selectIf(1);
assertEquals(2, list.get(0).getId());
assertEquals(10, list.size());
//分页时，实际返回的结果list类型是Page<E>，如果想取出分页信息，需要强制转换为Page<E>
assertEquals(182, ((Page) list).getTotal());
```

```java
//request: url?pageNum=1&pageSize=10
//支持 ServletRequest,Map,POJO 对象，需要配合 params 参数
PageHelper.startPage(request);
//紧跟着的第一个select方法会被分页
List<Country> list = countryMapper.selectIf(1);

//后面的不会被分页，除非再次调用PageHelper.startPage
List<Country> list2 = countryMapper.selectIf(null);
//list1
assertEquals(2, list.get(0).getId());
assertEquals(10, list.size());
//分页时，实际返回的结果list类型是Page<E>，如果想取出分页信息，需要强制转换为Page<E>，
//或者使用PageInfo类（下面的例子有介绍）
assertEquals(182, ((Page) list).getTotal());
//list2
assertEquals(1, list2.get(0).getId());
assertEquals(182, list2.size());
```

### [前端表格分页插件](https://github.com/wenzhixin/bootstrap-table/)

## 数据库设计

```sql
-- One-to-One
CREATE TABLE product(
  id VARCHAR(30) primary key,
  name VARCHAR(80) NOT NULL
);

CREATE TABLE product_price(
  id VARCHAR (30) PRIMARY KEY,
  product_id VARCHAR(30) UNIQUE,
  msrp DECIMAL(8, 2),
  sale_price DECIMAL (8, 2)
);

ALTER TABLE product_price ADD  CONSTRAINT `fk_product_price_product_id ` FOREIGN KEY(product_id) REFERENCES product(id);


-- One-to-Many
CREATE TABLE product_attributes(
  id VARCHAR (30) PRIMARY KEY,
  product_id VARCHAR(30),
  attr_key VARCHAR(60),
  attr_value VARCHAR (200)
);

ALTER TABLE product_attributes ADD CONSTRAINT `fk_product_attributes_product_id` FOREIGN KEY (product_id) references product(id);

-- Many-to-Many

CREATE TABLE teacher(
  id VARCHAR (30) PRIMARY KEY,
  name VARCHAR (60)
);
CREATE TABLE student(
  id VARCHAR (30) PRIMARY KEY,
  name VARCHAR (60)
);
CREATE TABLE teacher_student(
  teacher_id VARCHAR(30),
  student_id VARCHAR (30)
  PRIMARY KEY (teacher_id, student_id)
);

ALTER TABLE teacher_student ADD CONSTRAINT `fk_teacher_student_teacher_id` FOREIGN KEY (teacher_id ) references teacher(id);
ALTER TABLE teacher_student ADD CONSTRAINT `fk_teacher_student_student_id` FOREIGN KEY (student_id ) references student(id);

-- Self Reference
DROP TABLE IF EXISTS sdata_category;
CREATE TABLE sdata_category (
  id              VARCHAR(30) PRIMARY KEY,
  name            VARCHAR(80)         NOT NULL,
  parent_category VARCHAR(30),
  url             VARCHAR(200) UNIQUE NOT NULL,
  template        VARCHAR(60),
  begin_date      VARCHAR(20),
  end_date        VARCHAR(20),
  active          BOOLEAN   DEFAULT TRUE
);

ALTER TABLE sdata_category
  ADD CONSTRAINT `fk_sdata_category_parent` FOREIGN KEY (parent_category) REFERENCES sdata_category (id);

```

### 字段

```text
商品字段
商品名称
商品描述
关键词（做搜索用）
商品目录(parent category)
制造商 (manufacturer)
商品属性列表（譬如说 核数→8核, CPU频率→4×Cortex A73 2.2GHz +4*Cortex A53 1.7GHz）
建议零售价(MSRP)
实际售卖价(sale price)
生效开始时间（active begin date）
生效结束时间（active end date）
商品展示模板（template）
交叉销售商品列表（cross sale products）
向上销售产品列表（upsale sale products）
商品属性定义（譬如衣服有颜色、尺寸两个属性，商品创建SKU的时候需补充这两个信息）
SKU列表
创建人
创建时间
更新人
更新时间
```

SKU

```text
SKU名字
SKU描述
SKU图片上传
建议零售价(MSRP)
实际售卖价(sale price)
关键词（搜索用）
商品属性字段定义（譬如颜色：红，尺寸：L）
生效开始时间（active begin date）
生效结束时间（active end date）
```

## Mybatis Generator 生成代码分离,多表查询

Mybatis Generator生成代码分离
分离好处 ：如果表结构发生变化，我们可以重新利用generator生成代码，而不影响之前的生成的mapper和class文件。
分离办法：

```xml
rootInterface （generator-config.xml）
rootClass （generator-config.xml）
mybatis.mapper-locations (application.yml)
<overwrite>true</overwrite> (pom.xml)
```

Mybatis 多表查询